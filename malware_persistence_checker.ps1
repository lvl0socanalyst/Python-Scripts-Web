$hostname = $env:COMPUTERNAME
$logFile = "$PSScriptRoot\persistence_log${hostname}.txt"

function Write-Log {
    param (
        [string]$text,
        [switch]$IsSuspicious
    )
    Add-Content -Path $logFile -Value $text

    if ($IsSuspicious) {
        Write-Host $text
    }
}

function Show-Menu {
    Write-Host "`n=== Windows Persistence Checker ==="
    Write-Host "1. Scan Registry Persistence Keys (Show suspicious only)"
    Write-Host "2. Scan Services Registry (Show suspicious only)"
    Write-Host "3. Scan Scheduled Tasks (Show suspicious only)"
    Write-Host "4. Exit"
}

function Is-SuspiciousPath {
    param ([string]$value)

    if (-not $value) { return $false }

    $indicators = @(
        "AppData", "Temp", "Roaming", "LocalLow", "Public", "Users\\Public",
        "\.vbs", "\.js", "\.bat", "\.cmd", "\.ps1", "\.scr",
        "wscript.exe", "cscript.exe", "powershell.exe", "mshta.exe", "rundll32.exe", "cmd.exe",
        "System32\\Tasks", "Microsoft\\Windows\\CurrentVersion\\Explorer\\StartupApproved",
        "curl.exe", "wget.exe",
        "base64", "Invoke-", "DownloadString", "EncodedCommand"
    )

    foreach ($indicator in $indicators) {
        if ($value -match [regex]::Escape($indicator)) {
            return $true
        }
    }
    return $false
}

function Scan-RegistryKeys {
    Write-Log "`n--- Scanning Registry Persistence Keys ---"

    $regPaths = @(
        "HKCU:\Software\Microsoft\Windows\CurrentVersion\Run",
        "HKCU:\Software\Microsoft\Windows\CurrentVersion\RunOnce",
        "HKLM:\Software\Microsoft\Windows\CurrentVersion\Run",
        "HKLM:\Software\Microsoft\Windows\CurrentVersion\RunOnce",
        "HKLM:\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Image File Execution Options",
        "HKLM:\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon",
        "HKLM:\SOFTWARE\Microsoft\Active Setup\Installed Components",
        "HKLM:\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Windows",
        "HKLM:\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon\Notify"
    )

    foreach ($path in $regPaths) {
        Write-Log "`n [Checking]: $path"

        try {
            if (Test-Path $path) {
                $items = Get-ItemProperty -Path $path -ErrorAction Stop
                $props = $items.PSObject.Properties | Where-Object { $_.Name -ne "PSPath" -and $_.Value }

                if ($props) {
                    foreach ($prop in $props) {
                        $isSuspicious = Is-SuspiciousPath $prop.Value
                        $logEntry = " -> $($prop.Name): $($prop.Value)"
                        if ($isSuspicious) {
                            Write-Log " [!!] Suspicious -> $($prop.Name): $($prop.Value)" -IsSuspicious
                        } else {
                            Add-Content -Path $logFile -Value $logEntry
                        }
                    }
                } else {
                    Write-Log " [Empty]"
                }
            } else {
                Write-Log " [Path Not Found]"
            }
        } catch {
            Write-Log " [Access Denied or Error]: $_"
        }
    }
    Write-Log "`nResults saved to $logFile"
}

function Scan-ServicesRegistry {
    Write-Log "`n--- Scanning Services Registry ---"
    $servicesPath = "HKLM:\SYSTEM\CurrentControlSet\Services"

    try {
        Get-ChildItem $servicesPath | ForEach-Object {
            $serviceName = $_.PSChildName
            $imagePath = (Get-ItemProperty -Path $_.PSPath -ErrorAction SilentlyContinue).ImagePath

            if ($imagePath) {
                $isSuspicious = Is-SuspiciousPath $imagePath
                $logEntry = " -> ${serviceName}: ${imagePath}"
                if ($isSuspicious) {
                    Write-Log " [!!] Suspicious -> ${serviceName}: ${imagePath}" -IsSuspicious
                } else {
                    Add-Content -Path $logFile -Value $logEntry
                }
            }
        }
    } catch {
        Write-Log " [Error accessing Services key]: $_"
    }
}

function Check-ScheduledTasks {
    Write-Log "`n--- Scanning Scheduled Tasks ---"

    $tasks = Get-ScheduledTask | Where-Object {$_.TaskPath -notlike '\Microsoft\*'}

    foreach ($task in $tasks) {
        try {
            $taskInfo = (Get-ScheduledTaskInfo -TaskName $task.TaskName -TaskPath $task.TaskPath)
            $actions = ($task.Actions | ForEach-Object { $_.Execute + " " + $_.Arguments }) -join " "
            $fullEntry = "[$($task.TaskName)] $actions"
            Write-Log $fullEntry

            if ($actions -match 'AppData|Temp|\.ps1|\.bat|\.vbs|http[s]?://|[A-Za-z0-9+/]{100,}') {
                Write-Host "[!] Suspicious Task: $($task.TaskName)"
                Write-Host "    Action: $actions"
            }

        } catch {
            Write-Log "Could not retrieve info for task $($task.TaskName): $_"
        }
    }
}

do {
    Show-Menu
    $choice = Read-Host "Enter selection"

    switch ($choice) {
        "1" {
            Scan-RegistryKeys
            Write-Host "--- Review full output in txt ---"
            Pause
        }
        "2" {
            Scan-ServicesRegistry
            Write-Host "--- Review full output in txt ---"
            Pause
        }
        "3" {
            Check-ScheduledTasks
            Write-Host "--- Review full output in txt ---"
            Pause
        }
        "4" {
            Write-Host "Exiting..."
            break
        }
        default {
            Write-Host "Invalid selection. Try again."
            Pause
        }
    }
} while ($true)
